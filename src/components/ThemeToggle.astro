---
/**
 * Theme toggle component with light, dark, and system options.
 *
 * Renders a dropdown menu allowing users to switch between three
 * theme modes:
 * - Light: Forces light theme regardless of system preference
 * - Dark: Forces dark theme regardless of system preference
 * - System: Automatically follows OS/browser color scheme preference
 *
 * The selected theme is persisted to localStorage and applied
 * immediately. The component updates the HTML element's 'dark' class
 * and listens for system preference changes when in system mode.
 *
 * Uses astro-icon for consistent, scalable icon rendering from
 * the Material Design Icons set.
 *
 * @example
 * <ThemeToggle />
 */

import { Icon } from 'astro-icon/components';

type ThemeMode = 'light' | 'dark' | 'system';
---

<div class="relative theme-toggle">
	<button
		type="button"
		id="theme-button"
		class="flex items-center gap-2 px-4 py-2 rounded-lg bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors border border-gray-300 dark:border-gray-600"
		aria-label="Toggle theme"
		aria-expanded="false"
	>
		<Icon id="theme-icon-light" name="mdi:white-balance-sunny" class="w-5 h-5 hidden" />
		<Icon id="theme-icon-dark" name="mdi:moon-waning-crescent" class="w-5 h-5 hidden" />
		<Icon id="theme-icon-system" name="mdi:monitor" class="w-5 h-5 hidden" />
	</button>

	<div
		id="theme-menu"
		class="absolute right-0 mt-2 w-40 rounded-lg bg-white dark:bg-gray-800 shadow-lg border border-gray-200 dark:border-gray-700 hidden z-10"
		role="menu"
	>
		<button
			type="button"
			data-theme="light"
			class="w-full flex items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-t-lg transition-colors"
			role="menuitem"
		>
			<Icon name="mdi:white-balance-sunny" class="w-4 h-4" />
			<span>Light</span>
			<Icon name="mdi:check" class="w-4 h-4 ml-auto checkmark hidden" />
		</button>
		<button
			type="button"
			data-theme="dark"
			class="w-full flex items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
			role="menuitem"
		>
			<Icon name="mdi:moon-waning-crescent" class="w-4 h-4" />
			<span>Dark</span>
			<Icon name="mdi:check" class="w-4 h-4 ml-auto checkmark hidden" />
		</button>
		<button
			type="button"
			data-theme="system"
			class="w-full flex items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-b-lg transition-colors"
			role="menuitem"
		>
			<Icon name="mdi:monitor" class="w-4 h-4" />
			<span>System</span>
			<Icon name="mdi:check" class="w-4 h-4 ml-auto checkmark hidden" />
		</button>
	</div>
</div>

<script>
	/**
	 * Valid theme mode options.
	 */
	type ThemeMode = 'light' | 'dark' | 'system';

	/**
	 * Apply theme to the document.
	 *
	 * Updates the HTML element's classList to add or remove the 'dark'
	 * class based on the selected theme. For 'system' mode, checks the
	 * browser's prefers-color-scheme media query.
	 *
	 * @param theme - The theme mode to apply
	 *
	 * @example
	 * applyTheme('dark');  // Forces dark mode
	 * applyTheme('system'); // Follows system preference
	 */
	function applyTheme(theme: ThemeMode): void {
		if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
			document.documentElement.classList.add('dark');
		} else {
			document.documentElement.classList.remove('dark');
		}
	}

	/**
	 * Update theme toggle UI to reflect current selection.
	 *
	 * Shows the appropriate icon in the toggle button and adds
	 * checkmarks to the selected option in the dropdown menu.
	 *
	 * @param theme - Current theme mode
	 */
	function updateThemeUI(theme: ThemeMode): void {
		const icons = {
			light: document.getElementById('theme-icon-light'),
			dark: document.getElementById('theme-icon-dark'),
			system: document.getElementById('theme-icon-system')
		};

		Object.entries(icons).forEach(([key, icon]) => {
			if (icon) {
				icon.classList.toggle('hidden', key !== theme);
			}
		});

		document.querySelectorAll('[data-theme]').forEach((button) => {
			const checkmark = button.querySelector('.checkmark');
			const isSelected = button.getAttribute('data-theme') === theme;
			checkmark?.classList.toggle('hidden', !isSelected);
		});
	}

	/**
	 * Set and persist theme preference.
	 *
	 * Saves the selected theme to localStorage, applies it to the
	 * document, and updates the UI. This function is called when
	 * the user selects a theme from the dropdown menu.
	 *
	 * @param theme - Theme mode to set
	 *
	 * @example
	 * setTheme('dark');    // Switch to dark mode
	 * setTheme('system');  // Follow system preference
	 */
	function setTheme(theme: ThemeMode): void {
		localStorage.setItem('theme', theme);
		applyTheme(theme);
		updateThemeUI(theme);
	}

	/**
	 * Initialize theme toggle component on page load.
	 *
	 * Sets up event listeners for the toggle button and menu options.
	 * Loads the saved theme preference and updates the UI accordingly.
	 * Also listens for system color scheme changes when in system mode.
	 */
	const themeButton = document.getElementById('theme-button');
	const themeMenu = document.getElementById('theme-menu');
	const currentTheme = (localStorage.getItem('theme') as ThemeMode) || 'system';

	updateThemeUI(currentTheme);

	themeButton?.addEventListener('click', () => {
		const isExpanded = themeButton.getAttribute('aria-expanded') === 'true';
		themeButton.setAttribute('aria-expanded', String(!isExpanded));
		themeMenu?.classList.toggle('hidden');
	});

	document.querySelectorAll('[data-theme]').forEach((button) => {
		button.addEventListener('click', () => {
			const theme = button.getAttribute('data-theme') as ThemeMode;
			setTheme(theme);
			themeMenu?.classList.add('hidden');
			themeButton?.setAttribute('aria-expanded', 'false');
		});
	});

	document.addEventListener('click', (e) => {
		const target = e.target as HTMLElement;
		if (!target.closest('.theme-toggle')) {
			themeMenu?.classList.add('hidden');
			themeButton?.setAttribute('aria-expanded', 'false');
		}
	});

	window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
		const theme = localStorage.getItem('theme') as ThemeMode;
		if (theme === 'system') {
			applyTheme('system');
		}
	});
</script>
