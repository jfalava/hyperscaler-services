---
/**
 * Main page displaying AWS, Azure, and GCP service comparisons.
 *
 * Renders a bilingual (English/Spanish) table of cloud service
 * equivalents between AWS, Azure, and Google Cloud Platform. Users can:
 * - Switch languages via URL parameter (?lang=en or ?lang=es)
 * - Search/filter services in real-time using the search bar
 * - Browse services organized by category
 *
 * The page is server-side rendered dynamically on each request
 * to support language switching via query parameters.
 *
 * @example
 * // English version
 * http://hyperscalers.jfa.dev/?lang=en
 *
 * @example
 * // Spanish version
 * http://hyperscalers.jfa.dev/?lang=es
 */

export const prerender = false;

import Layout from '@/layouts/Layout.astro';
import FloatingButtons from '@/components/FloatingButtons.astro';
import Pagination from '@/components/Pagination.astro';
import { Icon } from 'astro-icon/components';
import { fetchServices, type ServiceMapping } from '@/data/services';

/**
 * Supported language codes for the application.
 */
type LanguageCode = 'en' | 'es';

/**
 * UI text translations for the main page.
 *
 * Contains all user-facing strings used in the interface,
 * allowing the page to be displayed in multiple languages.
 */
interface PageTranslations {
	title: string;
	subtitle: string;
	searchPlaceholder: string;
	awsColumn: string;
	azureColumn: string;
	gcpColumn: string;
	categoryColumn: string;
	descriptionColumn: string;
	noResults: string;
	showing: string;
	of: string;
	services: string;
	previous: string;
	next: string;
}

/**
 * Extract language preference from URL query parameter.
 *
 * The language is controlled via ?lang=en or ?lang=es in the URL,
 * allowing users to switch languages and share links in their
 * preferred language. Defaults to English if not specified.
 */
const url = new URL(Astro.request.url);
const lang = url.searchParams.get('lang') || 'en';

/**
 * Get localized UI strings based on the current language.
 *
 * Returns all text content for the page in the appropriate language,
 * including headings, button labels, and table column headers.
 *
 * @param currentLang - The language code to use for translations
 * @returns Object containing all translated strings for the UI
 *
 * @example
 * const t = getTranslations('es');
 * console.log(t.title); // "Servicios de Hyperscalers"
 */
const getTranslations = (currentLang: string): PageTranslations => {
	return {
		title: currentLang === 'es' ? 'Servicios de Hyperscalers' : 'Hyperscaler Services',
		subtitle: currentLang === 'es'
			? 'Compara servicios equivalentes entre AWS, Azure y Google Cloud'
			: 'Compare equivalent services between AWS, Azure, and Google Cloud',
		searchPlaceholder: currentLang === 'es'
			? 'Buscar servicios...'
			: 'Search services...',
		awsColumn: 'AWS',
		azureColumn: 'Azure',
		gcpColumn: 'GCP',
		categoryColumn: currentLang === 'es' ? 'Categoría' : 'Category',
		descriptionColumn: currentLang === 'es' ? 'Descripción' : 'Description',
		noResults: currentLang === 'es'
			? 'No se encontraron servicios'
			: 'No services found',
		showing: currentLang === 'es' ? 'Mostrando' : 'Showing',
		of: currentLang === 'es' ? 'de' : 'of',
		services: currentLang === 'es' ? 'servicios' : 'services',
		previous: currentLang === 'es' ? 'Anterior' : 'Previous',
		next: currentLang === 'es' ? 'Siguiente' : 'Next'
	};
};

const t = getTranslations(lang);
const currentLang = lang as LanguageCode;

/**
 * Load service data from JSON file.
 *
 * Services are fetched from /public/services.json during SSR.
 * This approach allows the data source to be easily swapped to
 * a database API endpoint in the future.
 */
const services: ServiceMapping[] = await fetchServices(Astro.url.origin);
---

<Layout
	title={t.title}
	description={t.subtitle}
	lang={currentLang}
>
	<div class="container mx-auto px-4 py-6 sm:py-8 max-w-7xl">
		<FloatingButtons currentLang={currentLang} />
		<header class="mb-6 sm:mb-8">
			<div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
				<div class="space-y-1">
					<h1 class="text-3xl sm:text-4xl font-bold text-foreground tracking-tight">{t.title}</h1>
					<p class="text-base sm:text-lg text-muted-foreground max-w-2xl">{t.subtitle}</p>
				</div>
			</div>

			<div class="relative">
				<input
					type="text"
					id="search"
					placeholder={t.searchPlaceholder}
					class="w-full mt-1 px-4 py-2 pl-12 border border-input rounded-lg bg-background text-foreground placeholder-muted-foreground focus:ring-2 focus:ring-ring focus:border-transparent transition-colors"
				/>
				<Icon
					name="mdi:magnify"
					class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-muted-foreground"
				/>
			</div>
		</header>

		<div class="bg-card rounded-lg shadow-md overflow-hidden border border-border">
			<div class="overflow-x-auto">
				<table class="w-full">
					<thead class="bg-muted border-b border-border">
						<tr>
							<th class="px-6 py-4 text-left text-sm font-semibold text-foreground">{t.categoryColumn}</th>
							<th class="px-6 py-4 text-left text-sm font-semibold text-foreground">{t.awsColumn}</th>
							<th class="px-6 py-4 text-left text-sm font-semibold text-foreground">{t.azureColumn}</th>
							<th class="px-6 py-4 text-left text-sm font-semibold text-foreground">{t.gcpColumn}</th>
							<th class="px-6 py-4 text-left text-sm font-semibold text-foreground">{t.descriptionColumn}</th>
						</tr>
					</thead>
					<tbody id="services-table">
						{services.map((service) => (
							<tr
								class={`border-b border-border hover:bg-accent/50 transition-colors service-row`}
								data-category={service.categoryName[currentLang].toLowerCase()}
								data-aws={service.aws.toLowerCase()}
								data-azure={service.azure.toLowerCase()}
								data-gcp={service.gcp.toLowerCase()}
								data-description={service.description[currentLang].toLowerCase()}
							>
								<td class="px-6 py-4 text-sm font-medium text-muted-foreground">
									{service.categoryName[currentLang]}
								</td>
								<td class="px-6 py-4 text-sm text-foreground font-medium">
									{service.aws}
								</td>
								<td class="px-6 py-4 text-sm text-foreground font-medium">
									{service.azure}
								</td>
								<td class="px-6 py-4 text-sm text-foreground font-medium">
									{service.gcp}
								</td>
								<td class="px-6 py-4 text-sm text-muted-foreground">
									{service.description[currentLang]}
								</td>
							</tr>
						))}
					</tbody>
				</table>
			</div>
			<div id="no-results" class="hidden p-8 text-center text-muted-foreground">
				{t.noResults}
			</div>
		</div>

		<Pagination 
			translations={{
				previous: t.previous,
				next: t.next
			}} 
		/>
	</div>

	<script>
		import { ServiceManager } from '../types/client';

		const serviceManager = new ServiceManager();
		
		document.addEventListener('DOMContentLoaded', () => {
			serviceManager.initialize();
		});
	</script>
</Layout>
